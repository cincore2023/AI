# 后端项目说明

## 项目概述

后端项目基于 [Gin-Vue-Admin](https://github.com/flipped-aurora/gin-vue-admin) 框架构建，采用 Go 语言开发，使用 Gin Web 框架和 GORM ORM 库。项目提供 RESTful API 接口，为前端管理界面和微信小程序提供数据支持和服务。

## 技术栈

- **语言**: Go 1.22+
- **框架**: Gin
- **ORM**: GORM
- **数据库**: PostgreSQL
- **缓存**: Redis
- **API 文档**: Swagger
- **配置管理**: Viper
- **日志**: Zap
- **权限控制**: Casbin
- **JWT认证**: golang-jwt/jwt
- **构建工具**: Go Modules

## 项目结构

```
server/
├── api/                    # API 接口层
│   └── v1/                 # v1 版本 API
├── config/                 # 配置文件
├── core/                   # 核心组件
├── docs/                   # Swagger 文档
├── global/                 # 全局变量
├── initialize/             # 初始化模块
├── middleware/             # 中间件
├── model/                  # 数据模型
├── router/                 # 路由配置
├── service/                # 业务逻辑层
├── source/                 # 数据初始化
├── utils/                  # 工具函数
├── main.go                 # 程序入口
└── config.yaml             # 配置文件
```

## 核心组件

### 1. 配置管理 (Viper)
- 支持多环境配置文件（debug、release、test）
- 支持命令行参数和环境变量覆盖
- 配置热更新功能
- 配置文件路径优先级：命令行 > 环境变量 > 默认值

### 2. 数据库管理 (GORM)
- 支持 PostgreSQL、MySQL、SQL Server 等多种数据库
- 连接池管理（最大空闲连接数、最大打开连接数）
- 自动迁移表结构
- 支持多数据库实例

### 3. 缓存管理 (Redis)
- 支持单机和集群模式
- JWT Token 黑名单管理
- 多实例 Redis 支持
- 连接池管理

### 4. 日志系统 (Zap)
- 结构化日志记录
- 日志级别控制（debug、info、warn、error）
- 日志文件分割
- 控制台和文件双重输出

### 5. 权限控制 (Casbin)
- 基于角色的访问控制（RBAC）
- RESTful 资源权限管理
- 策略动态加载
- 微信接口特殊处理

### 6. JWT 认证
- Token 生成和验证
- Token 刷新机制
- Token 黑名单管理
- 多点登录支持

## 核心功能模块

### 1. 用户管理系统
- 系统管理员用户管理
- 微信小程序用户管理
- 用户权限控制
- JWT Token 认证
- 多点登录限制
- 用户状态管理

### 2. 权限管理系统
- 角色管理
- 菜单管理
- API 接口权限控制
- Casbin 权限管理
- 按钮级别权限控制

### 3. 业务功能模块

#### 3.1 课程管理系统
**功能概述**:
- 课程信息管理（创建、编辑、删除、查询）
- 课程分类管理
- 讲师信息管理
- 课程定价和促销管理
- 课程上下架状态控制
- 课程收藏功能

**核心字段**:
- `CourseTitle`: 课程名称
- `Teacher`: 讲师（关联讲师表）
- `Category`: 课程分类（关联分类表）
- `CoverImage`: 封面图片
- `Type`: 课程类型（图文或视频）
- `Price`: 课程售价
- `OriginalPrice`: 标注原价（划线价格）
- `OnSale`: 上架状态
- `Sort`: 排序显示
- `ViewDetails`: 试看详情
- `CourseDetails`: 课程详细介绍
- `ApprenticeCount`: 虚拟学习人数展示
- `Hot`: 是否热门推荐
- `Exquisite`: 是否精品推荐

#### 3.2 活动管理系统
**功能概述**:
- 活动信息管理（创建、编辑、删除、查询）
- 活动分类管理
- 活动时间管理（展示时间和实际时间）
- 活动报名管理
- 活动状态控制
- 多种报名方式支持

**核心字段**:
- `ActivityName`: 活动名称
- `Price`: 活动价格
- `Category`: 活动分类（关联分类表）
- `CoverPicture`: 封面图片
- `ActualEnrollment`: 展示报名人数
- `RealEnrollment`: 真实报名人数
- `Status`: 活动状态
- `SortOrder`: 排序
- `StartTime`: 活动开始时间
- `EndTime`: 活动结束时间
- `ShowStartTime`: 展示开始时间
- `ShowEndTime`: 展示结束时间
- `Details`: 活动详情
- `RegistrationType`: 报名方式（付费报名、免费报名、兑换码报名）

#### 3.3 讲师管理系统
**功能概述**:
- 讲师信息管理
- 讲师头像管理
- 讲师介绍和描述
- 讲师排序

**核心字段**:
- `Avatar`: 讲师头像
- `Name`: 讲师姓名
- `Description`: 讲师简短描述
- `Introduction`: 讲师详细介绍
- `Sort`: 讲师排序

#### 3.4 分类管理系统
**功能概述**:
- 课程分类管理
- 活动分类管理
- 分类状态控制
- 分类排序
- 分类层级管理

**核心字段**:
- `CategoryName`: 分类名称
- `Status`: 分类状态
- `SortOrder`: 排序
- `Type`: 分类类型（课程分类、活动分类等）
- `ParentID`: 父级分类ID（支持多级分类）

#### 3.5 轮播图管理系统
**功能概述**:
- 首页轮播图管理
- 不同位置轮播图管理
- 轮播图状态控制
- 轮播图排序

**核心字段**:
- `ImageUrl`: 轮播图图片地址
- `LinkUrl`: 点击跳转链接
- `Order`: 轮播图顺序
- `Status`: 轮播图状态（启用/禁用）
- `Type`: 轮播图位置（首页、活动页等）

#### 3.6 海报管理系统
**功能概述**:
- 推广海报管理
- 海报元素位置调整
- 海报开关控制

**核心字段**:
- `Text`: 二维码信息
- `BgImg`: 背景图片
- `SwitchButton`: 功能开关
- `SizeSlider`: 元素大小
- `Radius`: 圆角设置
- `Top`: 距离顶部距离
- `Left`: 距离左侧距离

#### 3.7 权益等级管理系统
**功能概述**:
- 会员权益等级管理
- 不同等级提成设置
- 权益配置管理

**核心字段**:
- `Level`: 等级数值
- `LevelName`: 等级名称
- `MemberCommission`: 会员提成比例
- `ActivityCommission`: 活动提成比例
- `DigitalPersonCommission`: 数字人提成比例

#### 3.8 订单管理系统
**功能概述**:
- 订单创建和管理
- 订单状态跟踪
- 支付方式管理
- 订单金额计算

**核心字段**:
- `OrderNo`: 订单编号
- `UserID`: 用户ID
- `ActivityID`: 活动ID
- `ReferenceID`: 关联ID
- `OrderType`: 订单类型（活动、会员等）
- `Amount`: 订单金额
- `ActualAmount`: 实付金额
- `DiscountAmount`: 优惠金额
- `Status`: 订单状态（待支付、已支付、已取消、已退款）
- `PaymentMethod`: 支付方式
- `PaymentTime`: 支付时间
- `TradeNo`: 第三方交易号

#### 3.9 活动报名管理系统
**功能概述**:
- 活动报名记录管理
- 报名方式管理
- 核销码管理
- 支付状态跟踪

**核心字段**:
- `UserID`: 用户ID
- `ActivityID`: 活动ID
- `RegistrationType`: 报名方式
- `VerificationCode`: 核销码
- `VerificationStatus`: 核销状态
- `ParticipantName`: 参与人姓名
- `ParticipantPhone`: 参与人手机号
- `PaymentStatus`: 支付状态

#### 3.10 兑换码管理系统
**功能概述**:
- 会员兑换码管理
- 活动兑换码管理
- 兑换码交易记录
- 兑换码余量管理

**核心字段**:
- `TransactionID`: 交易编号
- `Username`: 用户昵称
- `PhoneNumber`: 用户手机号
- `TransactionType`: 交易类型
- `CodeType`: 兑换码类型（会员、活动）
- `Quantity`: 交易数量
- `RemainingQuantity`: 剩余数量
- `Details`: 交易详情
- `TransactionTime`: 交易时间

#### 3.11 课程收藏系统
**功能概述**:
- 用户课程收藏管理
- 收藏取消功能

**核心字段**:
- `UserID`: 用户ID
- `CourseID`: 课程ID

### 4. 微信集成模块
- 微信小程序登录
- 微信用户信息管理
- 微信支付集成
- 销售员绑定
- 会员体系管理

## 配置说明

### 系统配置
```yaml
system:
  db-type: "pgsql"            # 数据库类型
  oss-type: "local"           # 对象存储类型
  addr: 8888                  # 服务端口
  use-multipoint: false       # 是否启用多点登录
  use-redis: false            # 是否启用Redis
  wx-app-id: "微信小程序AppID"
  wx-app-secret: "微信小程序AppSecret"
```

### 数据库配置
```yaml
pgsql:
  path: "127.0.0.1"           # 数据库地址
  port: "5432"                # 数据库端口
  config: "sslmode=disable TimeZone=Asia/Shanghai"  # 连接参数
  db-name: "gva1"             # 数据库名
  username: "gva"             # 用户名
  password: "gva1234"         # 密码
  max-idle-conns: 10          # 最大空闲连接数
  max-open-conns: 100         # 最大打开连接数
```

### Redis 配置
```yaml
redis:
  addr: "127.0.0.1:6379"      # Redis 地址
  password: ""                # Redis 密码
  db: 0                       # Redis 数据库编号
```

### JWT 配置
```yaml
jwt:
  signing-key: "f95729a2-07cc-4b10-952c-c1baab4cbddc"  # 签名密钥
  expires-time: "7d"          # 过期时间
  buffer-time: "1d"           # 缓冲时间
  issuer: "qmPlus"            # 签发者
```

### 微信配置
```yaml
system:
  wx-app-id: "你的微信小程序AppID"
  wx-app-secret: "你的微信小程序AppSecret"
```

## API 接口

### 管理系统接口
- 用户管理: `/user/*`
- 角色管理: `/authority/*`
- 菜单管理: `/menu/*`
- API 管理: `/api/*`
- 字典管理: `/sysDictionary/*`
- 系统配置: `/system/*`

### 微信小程序接口
- 微信登录: `POST /api/wx/Login`
- 销售员绑定: `POST /api/wx/BindSalesperson`
- 用户信息: `/api/wx/UserInfo/*`
- 课程管理: `/api/wx/Course/*`
- 活动管理: `/api/wx/Activity/*`

## 数据库设计

### 主要数据表
- `sys_users`: 系统管理员用户表
- `User`: 微信小程序用户表
- `sys_authorities`: 角色权限表
- `sys_menus`: 系统菜单表
- `sys_apis`: API 接口表
- `core_courses`: 课程表
- `core_activities`: 活动表
- `program_teacher`: 讲师表
- `program_categories`: 分类表
- `program_banner`: 轮播图表
- `program_poster`: 海报表
- `program_benefit`: 权益表
- `orders`: 订单表
- `activity_registrations`: 活动报名表
- `finance_code`: 兑换码表
- `course_favorites`: 课程收藏表

### 微信用户表结构
```go
type WechatUser struct {
    ID                       uint       // 主键
    OpenId                   *string    // 微信openid
    Nickname                 *string    // 昵称
    PhoneNumber              *string    // 手机号
    Avatar                   *string    // 头像URL
    UserType                 *string    // 用户类型: normal-普通用户, vip-VIP用户, partner-合伙人
    Salesperson              *int       // 销售员
    RelationshipChannel      *int       // 关系渠道
    BenefitLevel             *int       // 权益等级
    WithdrawableIncome       *float64   // 可提现收入
    CumulativeIncome         *float64   // 累计收入
    MembershipExpiryDate     *time.Time // 会员到期时间
    MembershipRedemptionCode *string    // 会员兑换码
    ActivityRedemptionCode   *string    // 活动兑换码
    IsActive                 *bool      // 是否启用
    CreatedBy                uint       // 创建者
    UpdatedBy                uint       // 更新者
    DeletedBy                uint       // 删除者
}
```

## 认证与授权

### JWT 认证流程
1. 用户登录成功后生成 JWT Token
2. Token 包含用户基本信息和过期时间
3. 前端在请求头中携带 Token (Authorization: Bearer <token>)
4. 服务端通过中间件验证 Token 有效性
5. 支持 Token 自动刷新机制

### 权限控制流程
1. 用户请求受保护的资源
2. JWT 中间件验证 Token 有效性
3. Casbin 中间件检查用户权限
4. 根据策略决定是否允许访问

### 微信登录流程
1. 用户在微信小程序中点击登录
2. 小程序调用 `uni.login()` 获取 code
3. 将 code 发送到后端 `/api/wx/Login` 接口
4. 后端通过 code 向微信服务器换取 openid
5. 根据 openid 查找或创建用户
6. 生成 JWT token 返回给前端
7. 前端保存 token 并用于后续请求

## 启动项目

### 开发环境启动
```bash
# 进入后端服务目录
cd gin-vue-admin/server

# 安装依赖
go mod tidy

# 运行服务
go run main.go
```

### 生产环境部署
```bash
# 构建可执行文件
go build -o server main.go

# 运行构建后的文件
./server
```

### 命令行参数
```bash
# 指定配置文件
./server -c config.prod.yaml

# 设置环境变量
export GVA_CONFIG=config.prod.yaml && ./server
```

## API 文档

项目集成了 Swagger API 文档，启动服务后可通过以下地址访问：
- http://localhost:8888/swagger/index.html

## 日志管理

日志文件位于 `gin-vue-admin/server/log/` 目录下，包含：
- 运行日志
- 错误日志
- 数据库操作日志

日志配置：
```yaml
zap:
  level: "info"               # 日志级别
  format: "console"           # 输出格式
  director: "log"             # 日志目录
  show-line: true             # 显示行号
  log-in-console: true        # 控制台输出
```

## 性能监控

项目支持 MCP (Microservice Control Plane) 协议：
- SSE 地址: http://localhost:8888/sse
- Message 地址: http://localhost:8888/message

## 部署说明

### Docker 部署
```bash
# 构建 Docker 镜像
docker build -t gin-vue-admin-server .

# 运行容器
docker run -d -p 8888:8888 gin-vue-admin-server
```

### 环境要求
- Go 1.22+
- PostgreSQL 15
- Redis 7
- Docker & Docker Compose (可选)

## 常见问题

### 1. 数据库连接失败
- 检查数据库配置是否正确
- 确认数据库服务是否启动
- 检查防火墙设置

### 2. 微信登录失败
- 确认微信 AppID 和 AppSecret 配置正确
- 检查微信公众平台配置
- 确认服务器网络可以访问微信 API

### 3. API 接口访问 401 错误
- 检查 JWT Token 是否过期
- 确认请求头是否包含正确的 Authorization 字段
- 验证用户权限是否足够

### 4. 数据库迁移失败
- 检查数据库连接配置
- 确认数据库用户权限
- 查看日志文件获取详细错误信息