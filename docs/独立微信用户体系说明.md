# 独立微信小程序用户体系说明

## 功能概述

本项目为微信小程序实现了一个完全独立的用户体系，基于 [WechatUser](file:///Users/sado/code/cincore/AI/gin-vue-admin/server/model/system/usermanagement.go#L9-L26) 模型，与后端管理系统的 [SysUser](file:///Users/sado/code/cincore/AI/gin-vue-admin/server/model/system/sys_user.go#L19-L33) 体系完全独立。

## 已实现的功能

### 后端API

1. **独立微信登录接口**: `/base/wxLogin`
   - 接收微信小程序的登录code
   - 调用微信API获取用户openid
   - 自动创建或查找 [WechatUser](file:///Users/sado/code/cincore/AI/gin-vue-admin/server/model/system/usermanagement.go#L9-L26) 记录
   - 生成专用于微信用户的JWT token
   - 返回微信用户信息和token

2. **WechatUser数据模型**:
   ```go
   type WechatUser struct {
       ID                       uint
       OpenId                   *string    // 微信openid
       Nickname                 *string    // 用户昵称
       PhoneNumber              *string    // 手机号
       Salesperson              *int       // 销售员
       RelationshipChannel      *int       // 关系渠道
       BenefitLevel             *int       // 权益等级
       WithdrawableIncome       *float64   // 可提现收入
       CumulativeIncome         *float64   // 累计收入
       MembershipExpiryDate     *time.Time // 会员到期时间
       MembershipRedemptionCode *string    // 会员兑换码
       ActivityRedemptionCode   *string    // 活动兑换码
       IsActive                 *bool      // 是否启用
   }
   ```

3. **JWT Token管理**:
   - 为微信用户生成独立的JWT token
   - 使用系统统一的JWT配置和安全策略
   - Token包含微信用户的基本信息

### 前端UI

1. **登录页面**: `/pages/login/login.vue`
   - 精美的登录界面设计
   - 微信一键登录功能
   - 游客模式选项
   - 用户协议确认机制

2. **用户状态管理**:
   - 独立的微信用户store
   - 支持用户登录状态持久化
   - 自动token管理

## 核心特性

### 1. 完全独立的用户体系
- 微信小程序用户与后端管理系统用户完全分离
- 使用独立的数据表和模型
- 独立的认证和授权机制

### 2. 业务数据支持
- 支持销售员分配
- 会员等级管理
- 收入统计和提现功能
- 兑换码管理
- 活动管理

### 3. 安全认证
- 基于微信官方登录流程
- JWT token安全管理
- 自动token过期处理

## 配置要求

### 后端配置

在 `gin-vue-admin/server/config.yaml` 中添加微信配置：

```yaml
system:
  wx-app-id: "你的微信小程序AppID"
  wx-app-secret: "你的微信小程序AppSecret"
```

### 数据库

确保 [WechatUser](file:///Users/sado/code/cincore/AI/gin-vue-admin/server/model/system/usermanagement.go#L9-L26) 表已经创建，表名为 `User`。

## 使用流程

### 微信登录流程

1. 用户在小程序中点击"微信登录"
2. 调用 `uni.login()` 获取微信code
3. 将code发送到 `/base/wxLogin` 接口
4. 后端验证code并获取openid
5. 查找或创建 [WechatUser](file:///Users/sado/code/cincore/AI/gin-vue-admin/server/model/system/usermanagement.go#L9-L26) 记录
6. 生成JWT token并返回
7. 前端保存用户信息和token
8. 跳转到主页面

### 数据流转

```
小程序 -> 微信服务器 -> 小程序 -> 后端API -> WechatUser表
   |         |           |         |            |
 登录      获取code    发送code   验证&创建    用户数据
```

## 文件结构

### 后端文件

```
gin-vue-admin/server/
├── api/v1/system/sys_user.go          # 微信登录API (新增)
├── config/system.go                   # 配置结构 (已更新)
├── router/system/sys_base.go          # 路由注册 (已更新)
├── model/system/usermanagement.go     # WechatUser模型 (已存在)
└── config.yaml                       # 配置文件 (已更新)
```

### 前端文件

```
wechat/src/
├── pages/login/login.vue              # 登录页面 (新增)
├── api/login.ts                       # 登录API (已更新)
├── api/types/login.ts                 # 类型定义 (已更新)
├── store/user.ts                      # 用户状态管理 (已更新)
└── static/images/                     # 静态资源
```

## API接口说明

### POST `/base/wxLogin`

**请求参数:**
```json
{
  "code": "微信登录code"
}
```

**响应数据:**
```json
{
  "code": 0,
  "data": {
    "isNewUser": true,
    "user": {
      "id": 1,
      "openId": "wx_openid_here",
      "nickname": "微信用户12345678",
      "isActive": true,
      "benefitLevel": 1,
      "withdrawableIncome": 0,
      "cumulativeIncome": 0
    },
    "token": "jwt_token_here",
    "expiresAt": 1640995200000
  },
  "msg": "微信登录成功"
}
```

## 扩展功能建议

1. **用户信息完善**:
   - 手机号绑定
   - 头像上传
   - 个人资料管理

2. **业务功能**:
   - 会员系统
   - 积分系统
   - 推荐奖励
   - 提现功能

3. **数据分析**:
   - 用户行为统计
   - 收入报表
   - 活动效果分析

## 注意事项

1. **安全性**: 确保微信AppSecret的安全，不要泄露
2. **数据隔离**: 微信用户数据与后端管理用户完全隔离
3. **权限控制**: 微信用户具有独立的权限体系
4. **数据同步**: 必要时可以考虑与后端用户的数据同步机制

## 技术架构

```
微信小程序前端
    ↓
独立的用户store (WechatUser)
    ↓
微信登录API (/base/wxLogin)
    ↓
WechatUser数据表
    ↓
独立的JWT Token体系
```

这个设计确保了微信小程序用户体系的完全独立性，同时保持了与现有系统的兼容性。